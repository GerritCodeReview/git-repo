{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "65a49ef7_3e476191",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010522
      },
      "writtenOn": "2020-12-07T19:36:00Z",
      "side": 1,
      "message": "Hi,\nWe ran into this issue today, it is not v2.10 related issue. It is in there for a longer time.\n\nKind regards,\nRemy ",
      "revId": "cbdd3c51a1bc7a8672015cf06bed5bd22f178c7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c8665ba4_3ecb8c16",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1007145
      },
      "writtenOn": "2020-12-08T00:23:41Z",
      "side": 1,
      "message": "thanks ... i had actually seen this in my checkouts of late, but hadn\u0027t gotten around to investigating it.  it also seemed inconsistent (only a subset of my repos had this prob), but that might be due to ongoing migrations where we\u0027ve been switching the default branch from master-\u003emain.\n\nalong those lines, the issue isn\u0027t with \"master\" exactly, it\u0027s with whatever the default remote branch is.  looking at a CrOS project that uses \"main\", if i create a local branch named \"main\", things get into the same bad state.\n\ni\u0027m not sure this change is correct.  in my testing locally, it points HEAD to the remote which is an odd value for HEAD to be in general.  but i\u0027m not entirely clear as to the implication of having HEAD in this bare repo at all.  or why git is choking in the first place.\n\nwhat if we just deleted HEAD ?  it serves no purpose in the bare checkout.  it seems to work for me.",
      "revId": "cbdd3c51a1bc7a8672015cf06bed5bd22f178c7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "498db1fa_73ca224d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010522
      },
      "writtenOn": "2020-12-08T08:08:28Z",
      "side": 1,
      "message": "\u003e i\u0027m not sure this change is correct.  in my testing locally, it points HEAD to the remote which is an odd value for HEAD to be in general. \n\nThat was intentionally: make it point to an existing ref that is not a local branch. It is a bit odd but technically valid.\n\n\u003e but i\u0027m not entirely clear as to the implication of having HEAD in this bare repo at all.  or why git is choking in the first place.\n\nSince HEAD is pointing to the local master branch, Git assumes \u0027master\u0027 is checked out in a different worktree than the one currently active. Hence it forbids the deletion. And since it assumes that branch is already checked out in another worktree, it prohibits the checkout of the same branch in another worktree. Conclusion: HEAD may not point to any local branch in the bare Git.\n\n\u003e what if we just deleted HEAD ?  it serves no purpose in the bare checkout.  it seems to work for me.\n\nIf you go to the bare git and try to open a Git history viewer, it will complain about \u0027This Git repository does not contain any commits\u0027 if HEAD is being deleted. So, I am not sure if deleting HEAD is the right way forward, even though it has no other functional use in this Git worktree setup. I think it needs to exist, and point to something valid, even though it can be odd. It may also point to any valid Commit-sha1, as long is it not a local branch.",
      "parentUuid": "c8665ba4_3ecb8c16",
      "revId": "cbdd3c51a1bc7a8672015cf06bed5bd22f178c7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "76424631_26acb156",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1007145
      },
      "writtenOn": "2020-12-13T04:22:35Z",
      "side": 1,
      "message": "messing with repos directly under .repo/ isn\u0027t really a supported workflow, but we prob shouldn\u0027t go out of our way to break it.\n\nas is, this breaks the manifest checkout (.repo/manifests.git/) which then upsets things beyond that when trying to find the \"manifest branch\".  _InitGitWorktree only fires when first creating the checkout, so that wouldn\u0027t help when switching branches later on.\n\ni think we need to have the logic be in _InitMRef, and figure out how to handle the manifest project specially.\n\ni\u0027ve been testing with a small checkout like:\n\n repo init -c -u http://chromium.googlesource.com/chromiumos/manifest -g moblab --worktree\n repo sync -c\n git --git-dir\u003d.repo/manifests.git branch\n git --git-dir\u003d.repo/worktrees/chromiumos/platform/moblab.git branch",
      "parentUuid": "498db1fa_73ca224d",
      "revId": "cbdd3c51a1bc7a8672015cf06bed5bd22f178c7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2437de83_87fcab6e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1007145
      },
      "writtenOn": "2020-12-13T05:08:14Z",
      "side": 1,
      "message": "maybe we always detach HEAD and call it a day ?  a bit hacky, but this seems to work for me.\n\n --- a/project.py\n +++ b/project.py\n @@ -2555,6 +2555,8 @@ class Project(object):\n  \n          base \u003d R_WORKTREE_M\n          active_git \u003d self.work_git\n +\n +        self._InitAnyMRef(HEAD, self.bare_git, detach\u003dTrue)\n        else:\n          base \u003d R_M\n          active_git \u003d self.bare_git\n @@ -2564,7 +2566,7 @@ class Project(object):\n    def _InitMirrorHead(self):\n      self._InitAnyMRef(HEAD, self.bare_git)\n  \n -  def _InitAnyMRef(self, ref, active_git):\n +  def _InitAnyMRef(self, ref, active_git, detach\u003dFalse):\n      \"\"\"Initialize |ref| in |active_git| to the value in the manifest.\n  \n      This points |ref| to the \u003cproject\u003e setting in the manifest.\n @@ -2581,7 +2583,10 @@ class Project(object):\n        dst \u003d remote.ToLocal(self.revisionExpr)\n        if cur !\u003d dst:\n          msg \u003d \u0027manifest set to %s\u0027 % self.revisionExpr\n -        active_git.symbolic_ref(\u0027-m\u0027, msg, ref, dst)\n +        if detach:\n +          active_git.UpdateRef(ref, dst, message\u003dmsg, detach\u003dTrue)\n +        else:\n +          active_git.symbolic_ref(\u0027-m\u0027, msg, ref, dst)\n  \n    def _CheckDirReference(self, srcdir, destdir, share_refs):\n      # Git worktrees don\u0027t use symlinks to share at all.",
      "parentUuid": "76424631_26acb156",
      "revId": "cbdd3c51a1bc7a8672015cf06bed5bd22f178c7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b027377b_c68cdbe0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010522
      },
      "writtenOn": "2020-12-15T18:09:18Z",
      "side": 1,
      "message": "Hi,\nI think this approach is good enough too. It works in my case.\nI uploaded a new patch based on this approach.",
      "parentUuid": "2437de83_87fcab6e",
      "revId": "cbdd3c51a1bc7a8672015cf06bed5bd22f178c7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "33299c00_6876fac4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1007145
      },
      "writtenOn": "2020-12-26T07:30:36Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b027377b_c68cdbe0",
      "revId": "cbdd3c51a1bc7a8672015cf06bed5bd22f178c7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}