{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "ac65eb41_93af7d90",
        "filename": "ssh.py",
        "patchSetId": 8
      },
      "lineNbr": 348,
      "author": {
        "id": 1141766
      },
      "writtenOn": "2024-03-18T07:55:56Z",
      "side": 1,
      "message": "I have another idea how to do this without trying to imitate git behavior. Below should be backwards and forwards compatible with whatever behavior git might have. With the compromise of fiddling with shell and ssh-variant.\n\n```py\ndef _get_git_protocol_version2() -\u003e str:\n    with tempfile.TemporaryDirectory() as tempdir:\n        outfile \u003d os.path.join(tempdir, \"protocol.txt\")\n        fake_ssh_capturing_envvar \u003d f\"\"\"/usr/bin/sh -c \u0027\n            echo \"$GIT_PROTOCOL\" \u003e {shlex.quote(outfile)}\n            false\u0027\n        \"\"\"\n        \n        # Don\u0027t check exit code, it is expected to fail\n        subprocess.call(\n            [\"git\", \"clone\", \"ssh://any_domain/any_path\"],\n            env\u003d{\n                \"GIT_SSH_COMMAND\": fake_ssh_capturing_envvar,\n                \"GIT_SSH_VARIANT\": \"ssh\",\n            },\n            stderr\u003dsubprocess.PIPE,\n        )\n        return Path(outfile).read_text().strip()\n```\n\nLet me know what you think.",
      "revId": "1b4e4a6064911c7d01a3d3ca21bf169ffad43dad",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}