{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "6c56fc28_2a5905b3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1007145
      },
      "writtenOn": "2025-11-05T19:12:10Z",
      "side": 1,
      "message": "this logic seems to basically be a recovery for when _InitGitDir failed (i.e. was interrupted), but the Exception block wasn\u0027t run for whatever reason (where it deletes the gitdir).  and it relies on the current _InitGitDir implementation where it assumes the last thing it did was toggle core.bare, and it doesn\u0027t handle partial mirror init.\n\ni think this is a bandaid over the actual bug ... we shouldn\u0027t init the real directory in-situ.  _InitGitDir should initialize a temp dir, and only once it\u0027s finished, rename it to the final dir.",
      "revId": "7e63a543e40fbb01348f52805dc232b471b3b163",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "032ccf45_454f39d5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2025-11-05T19:30:31Z",
      "side": 1,
      "message": "\u003e this logic seems to basically be a recovery for when _InitGitDir failed (i.e. was interrupted), but the Exception block wasn\u0027t run for whatever reason (where it deletes the gitdir).  and it relies on the current _InitGitDir implementation where it assumes the last thing it did was toggle core.bare, and it doesn\u0027t handle partial mirror init.\n\nYes. There\u0027s a lot of cases that could cause failures that aren\u0027t helped by this change and I don\u0027t love that.\n\n\u003e \n\u003e i think this is a bandaid over the actual bug ... we shouldn\u0027t init the real directory in-situ.  _InitGitDir should initialize a temp dir, and only once it\u0027s finished, rename it to the final dir.\n\nThis sounds like a much nicer generic solution. I think we\u0027d want that temp dir in roughly the same location (i.e. don\u0027t use `$TMPDIR`) because using different/unexpected volumes during sync isn\u0027t nice. Should we do something like `.repo/projects/path/to/.tempXXXX-project` (`XXXX` replaced with random characters)? Then we can also do automatic cleanup of dirs under `/projects/` named like `.tempXXXX-`.\n\nI\u0027m not sure if we can do the same thing for `project-objects/` dirs, but that should be handled in a separate change anyway.",
      "parentUuid": "6c56fc28_2a5905b3",
      "revId": "7e63a543e40fbb01348f52805dc232b471b3b163",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c104bf61_e78b6930",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1012457
      },
      "writtenOn": "2025-11-06T19:30:58Z",
      "side": 1,
      "message": "Attempted in PS3",
      "parentUuid": "032ccf45_454f39d5",
      "revId": "7e63a543e40fbb01348f52805dc232b471b3b163",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "79fef828_b462974e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1007145
      },
      "writtenOn": "2025-11-25T18:19:29Z",
      "side": 1,
      "message": "\u003e Yes. There\u0027s a lot of cases that could cause failures that aren\u0027t helped by this change and I don\u0027t love that.\n\ncertainly.  i wouldn\u0027t expect you to fix all of them, but if we\u0027re going to focus on one, we should actually fix it :).\n\n\u003e I think we\u0027d want that temp dir in roughly the same location (i.e. don\u0027t use $TMPDIR)\n\ncorrect, it needs to be in the same dir tree as where it ends up so we can do an atomic rename() on the dir itself and not worry about perms/owners/disk space/copying/etc... to drag out.\n\n\u003e Should we do something like .repo/projects/path/to/.tempXXXX-project (XXXX replaced with random characters)? Then we can also do automatic cleanup of dirs under /projects/ named like .tempXXXX-.\n\n(i\u0027ll rename your examples slightly to avoid confusion)\n\nif the final path is `.repo/projects/path/to/foobar.git`, then let\u0027s use `.repo/projects/path/to/.tmpXXXXXX-\u003cname for repo step\u003e/foobar.git`.  so we could use like `project-initgitdir` since this is `project.py:InitGitDir` setting things up.\n\ni don\u0027t think we\u0027d want to use something like `.tmpXXXXXX-foobar.git` because it could cause filename length issues.  if `project` were actually a very long name that is just short of filesystem limits, adding `.tmpXXXXXX-` takes away more from that space.  certainly an edge case, but i don\u0027t think it provides any advantages over a name we know would never hit the limits.\n\nin terms of cleanup, i don\u0027t think a `glob.glob(\u0027.tmp*-project-initgitdir/foo.bar\u0027)` is expensive at all.  there shouldn\u0027t be that many orphaned `.tmp` dirs, and if there are none, the glob should basically be a noop.",
      "parentUuid": "c104bf61_e78b6930",
      "revId": "7e63a543e40fbb01348f52805dc232b471b3b163",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e78bdd85_f4c05349",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1012457
      },
      "writtenOn": "2025-11-25T20:27:12Z",
      "side": 1,
      "message": "\u003e \u003e Yes. There\u0027s a lot of cases that could cause failures that aren\u0027t helped by this change and I don\u0027t love that.\n\u003e \n\u003e certainly.  i wouldn\u0027t expect you to fix all of them, but if we\u0027re going to focus on one, we should actually fix it :).\n\u003e \n\u003e \u003e I think we\u0027d want that temp dir in roughly the same location (i.e. don\u0027t use $TMPDIR)\n\u003e \n\u003e correct, it needs to be in the same dir tree as where it ends up so we can do an atomic rename() on the dir itself and not worry about perms/owners/disk space/copying/etc... to drag out.\n\u003e \n\u003e \u003e Should we do something like .repo/projects/path/to/.tempXXXX-project (XXXX replaced with random characters)? Then we can also do automatic cleanup of dirs under /projects/ named like .tempXXXX-.\n\u003e \n\u003e (i\u0027ll rename your examples slightly to avoid confusion)\n\u003e \n\u003e if the final path is `.repo/projects/path/to/foobar.git`, then let\u0027s use `.repo/projects/path/to/.tmpXXXXXX-\u003cname for repo step\u003e/foobar.git`.  so we could use like `project-initgitdir` since this is `project.py:InitGitDir` setting things up.\n\u003e \n\n\nThis will be somewhat painful because we canâ€™t simply rename\n`.repo/projects/path/to/.tmpXXXXXX-\u003cname for repo step\u003e/foobar.git` to `.repo/projects/path/to/foobar.git` because the symlinks (`objects`, `hooks`, etc.) will break after the rename, as they were created using the tmp-gitdir path, which is not at the same level as the gitdir. We\u0027ll also need to fix the symlinks during the rename if we decide to do this. How about we instead ignore the project name (which addresses your concern about filename length issues) and create the tmp-gitdir at the same level as gitdir like `.tmpXXXXXX-project-initgitdir`. Skipping the project name might make it harder to identify which project the tmp directory belongs to, but if needed, we can look at the `config` inside it to determine that.\n\n\u003e i don\u0027t think we\u0027d want to use something like `.tmpXXXXXX-foobar.git` because it could cause filename length issues.  if `project` were actually a very long name that is just short of filesystem limits, adding `.tmpXXXXXX-` takes away more from that space.  certainly an edge case, but i don\u0027t think it provides any advantages over a name we know would never hit the limits.\n\u003e \n\u003e in terms of cleanup, i don\u0027t think a `glob.glob(\u0027.tmp*-project-initgitdir/foo.bar\u0027)` is expensive at all.  there shouldn\u0027t be that many orphaned `.tmp` dirs, and if there are none, the glob should basically be a noop.",
      "parentUuid": "79fef828_b462974e",
      "revId": "7e63a543e40fbb01348f52805dc232b471b3b163",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}